# This config was automatically generated from your source code
# Stacks detected: deps:node:.
version: 2.1
orbs:
  node: circleci/node@5.2
jobs:
  test-node:
    # Install node dependencies and run tests
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run tests
          command: |
            npm install
            npm test --passWithNoTests
  build-node:
    # Build node project
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          command: |
            npm i --package-lock-only
            npm install --save-dev firebase-tools
            npm run build
            echo "$SA_KEY" | base64 --decode > credentials.json
            GOOGLE_APPLICATION_CREDENTIALS=credentials.json npm exec -- firebase deploy
      # - persist_to_workspace:
      #     root: workspace
      #     paths:
      #       - node_modules
      # - run:
      #     name: Deploy app to Firebase
      # - run:
      #     name: Create the ~/artifacts directory if it doesn't exist
      #     command: mkdir -p ~/artifacts
      # # Copy output to artifacts dir
      # - run:
      #     name: Copy artifacts
      #     command: cp -R build dist public .output .next .docusaurus ~/artifacts 2>/dev/null || true
      # - store_artifacts:
      #     path: ~/artifacts
      #     destination: node-build
      # deploy:
      #   executor: node/default
      #   steps:
      #     - attach_workspace:
      #         at: /project/workspace
      # - checkout
      # - node/install-packages:
      #     pkg-manager: npm
      # - run:
      #     command: |
      #       npm i --package-lock-only
      #       npm install --save-dev firebase-tools
      #       npm run build
      - run:
          name: Deploy on Firebase
          command: |
            echo $SA_KEY > credentials.json 
            GOOGLE_APPLICATION_CREDENTIALS=credentials.json npm exec -- firebase deploy
workflows:
  build-and-test:
    jobs:
      # - test-node
      - build-node
      # requires:
      #   - test-node
      # - deploy:
      #     requires:
      #       - build-node
